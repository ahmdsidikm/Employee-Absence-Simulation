<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Otomatis - Deteksi Wajah AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        
        /* Scanning Animation */
        .scanning-line {
            position: absolute;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, transparent, #22c55e, #22c55e, transparent);
            animation: scan 2s linear infinite;
            box-shadow: 0 0 20px #22c55e;
        }
        @keyframes scan {
            0% { top: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        
        /* Corner Brackets */
        .corner-brackets::before,
        .corner-brackets::after {
            content: '';
            position: absolute;
            width: 60px;
            height: 60px;
            border: 4px solid #22c55e;
        }
        .corner-brackets::before {
            top: 20px;
            left: 20px;
            border-right: none;
            border-bottom: none;
            animation: pulse-corner 2s infinite;
        }
        .corner-brackets::after {
            bottom: 20px;
            right: 20px;
            border-left: none;
            border-top: none;
            animation: pulse-corner 2s infinite 0.5s;
        }
        @keyframes pulse-corner {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        
        /* Detection Notification */
        .detection-notification {
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .detection-notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        .detection-notification.hide {
            transform: translateY(100%);
            opacity: 0;
        }
        
        /* Success Glow Effect */
        .success-glow {
            animation: success-glow 0.5s ease-out;
        }
        @keyframes success-glow {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            50% { box-shadow: 0 0 40px 10px rgba(34, 197, 94, 0.5); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        
        /* Pulse Ring */
        .pulse-ring {
            animation: pulse-ring 1.5s infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.4); opacity: 0; }
        }
        
        /* Face Detected Animation */
        .face-detected {
            animation: face-bounce 0.5s ease-out;
        }
        @keyframes face-bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        /* Tab Styles */
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        /* Confidence Bar */
        .confidence-bar {
            transition: width 0.3s ease-out;
        }
        
        /* Status Indicator */
        .status-dot {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-100 to-gray-200 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6 shadow-2xl">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-center gap-3">
                <div class="text-4xl">ü§ñ</div>
                <div>
                    <h1 class="text-3xl font-extrabold">Sistem Absensi Otomatis</h1>
                    <p class="text-purple-200 text-sm mt-1">AI-Powered Face Recognition</p>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
            <div class="glass-card rounded-3xl p-10 text-center max-w-md mx-4 shadow-2xl">
                <div class="relative inline-block">
                    <div class="text-7xl mb-4">üß†</div>
                    <div class="absolute inset-0 rounded-full border-4 border-purple-500 pulse-ring"></div>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Memuat Model AI</h3>
                <p class="text-gray-600 mb-6">Sedang memuat model pengenalan wajah...</p>
                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div id="loadingProgress" class="bg-gradient-to-r from-purple-500 to-indigo-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p id="loadingText" class="text-sm text-gray-500 mt-3 font-medium">0%</p>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="flex justify-center mb-8">
            <div class="glass-card rounded-2xl p-2 shadow-xl flex gap-2">
                <button onclick="switchTab('register')" id="tabRegister" class="px-8 py-4 rounded-xl font-bold transition-all duration-300 tab-active">
                    üìù Daftar Wajah
                </button>
                <button onclick="switchTab('attendance')" id="tabAttendance" class="px-8 py-4 rounded-xl font-bold transition-all duration-300 text-gray-600 hover:bg-gray-100">
                    üì∑ Absensi Otomatis
                </button>
                <button onclick="switchTab('employees')" id="tabEmployees" class="px-8 py-4 rounded-xl font-bold transition-all duration-300 text-gray-600 hover:bg-gray-100">
                    üë• Data Karyawan
                </button>
            </div>
        </div>

        <!-- Register Tab -->
        <div id="registerSection" class="grid lg:grid-cols-2 gap-8">
            <div class="glass-card rounded-3xl shadow-xl p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                    <span class="text-3xl">üì∏</span> Daftarkan Wajah Baru
                </h2>
                
                <div class="relative rounded-2xl overflow-hidden bg-gray-900">
                    <video id="registerVideo" class="w-full aspect-video object-cover" autoplay playsinline></video>
                    <canvas id="registerCanvas" class="absolute top-0 left-0 w-full h-full"></canvas>
                    <div id="registerStatus" class="absolute inset-0 flex items-center justify-center bg-gray-900">
                        <div class="text-center text-white">
                            <div class="text-6xl mb-4">üë§</div>
                            <p class="text-lg">Klik tombol untuk mengaktifkan kamera</p>
                        </div>
                    </div>
                    <!-- Face Detection Indicator -->
                    <div id="regFaceIndicator" class="hidden absolute top-4 left-4 bg-green-500 text-white px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2">
                        <span class="w-2 h-2 bg-white rounded-full status-dot"></span>
                        Wajah Terdeteksi
                    </div>
                </div>
                
                <button id="startRegisterCamera" onclick="startRegisterCamera()" class="w-full mt-6 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-4 px-6 rounded-2xl font-bold transition-all flex items-center justify-center gap-3 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <span class="text-xl">üé•</span> Aktifkan Kamera
                </button>

                <div class="mt-8 space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">ID Karyawan *</label>
                        <input type="text" id="regEmployeeId" placeholder="Contoh: EMP001" 
                            class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-200 focus:border-purple-500 outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Nama Lengkap *</label>
                        <input type="text" id="regEmployeeName" placeholder="Masukkan nama lengkap" 
                            class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-200 focus:border-purple-500 outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Departemen</label>
                        <select id="regDepartment" class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-200 focus:border-purple-500 outline-none transition-all">
                            <option value="">Pilih Departemen</option>
                            <option value="IT">IT</option>
                            <option value="HRD">HRD</option>
                            <option value="Finance">Finance</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Operations">Operations</option>
                        </select>
                    </div>
                    <button onclick="registerFace()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-5 px-8 rounded-2xl font-bold transition-all flex items-center justify-center gap-3 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 text-lg">
                        <span class="text-2xl">‚úÖ</span> Daftarkan Wajah
                    </button>
                </div>
            </div>

            <div class="glass-card rounded-3xl shadow-xl p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                    <span class="text-3xl">üìã</span> Panduan Pendaftaran
                </h2>
                <div class="space-y-4">
                    <div class="flex gap-4 p-5 bg-gradient-to-r from-blue-50 to-blue-100 rounded-2xl border border-blue-200">
                        <span class="text-3xl">1Ô∏è‚É£</span>
                        <div>
                            <p class="font-bold text-gray-800">Aktifkan Kamera</p>
                            <p class="text-sm text-gray-600 mt-1">Klik tombol "Aktifkan Kamera" dan izinkan akses</p>
                        </div>
                    </div>
                    <div class="flex gap-4 p-5 bg-gradient-to-r from-green-50 to-green-100 rounded-2xl border border-green-200">
                        <span class="text-3xl">2Ô∏è‚É£</span>
                        <div>
                            <p class="font-bold text-gray-800">Posisikan Wajah</p>
                            <p class="text-sm text-gray-600 mt-1">Pastikan wajah terlihat jelas dengan pencahayaan baik</p>
                        </div>
                    </div>
                    <div class="flex gap-4 p-5 bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-2xl border border-yellow-200">
                        <span class="text-3xl">3Ô∏è‚É£</span>
                        <div>
                            <p class="font-bold text-gray-800">Isi Data Karyawan</p>
                            <p class="text-sm text-gray-600 mt-1">Masukkan ID, nama lengkap, dan departemen</p>
                        </div>
                    </div>
                    <div class="flex gap-4 p-5 bg-gradient-to-r from-purple-50 to-purple-100 rounded-2xl border border-purple-200">
                        <span class="text-3xl">4Ô∏è‚É£</span>
                        <div>
                            <p class="font-bold text-gray-800">Daftarkan Wajah</p>
                            <p class="text-sm text-gray-600 mt-1">Klik tombol "Daftarkan Wajah" untuk menyimpan</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 p-5 bg-gradient-to-r from-amber-50 to-orange-100 border-2 border-amber-300 rounded-2xl">
                    <p class="text-amber-800 font-bold flex items-center gap-2 text-lg">
                        <span>‚ö†Ô∏è</span> Catatan Penting
                    </p>
                    <p class="text-sm text-amber-700 mt-2">Sistem akan mendeteksi wajah secara otomatis. Pastikan hanya satu wajah yang terlihat di kamera saat pendaftaran.</p>
                </div>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendanceSection" class="hidden grid lg:grid-cols-2 gap-8">
            <div class="glass-card rounded-3xl shadow-xl p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                    <span class="text-3xl">ü§ñ</span> Deteksi Wajah Otomatis
                    <span id="liveIndicator" class="hidden ml-auto bg-red-500 text-white text-xs px-3 py-1 rounded-full font-bold flex items-center gap-2">
                        <span class="w-2 h-2 bg-white rounded-full status-dot"></span> LIVE
                    </span>
                </h2>
                
                <div id="cameraContainer" class="relative rounded-2xl overflow-hidden bg-gray-900">
                    <video id="attendanceVideo" class="w-full aspect-video object-cover" autoplay playsinline></video>
                    <canvas id="attendanceCanvas" class="absolute top-0 left-0 w-full h-full pointer-events-none"></canvas>
                    
                    <!-- Camera Placeholder -->
                    <div id="attendanceStatus" class="absolute inset-0 flex items-center justify-center bg-gray-900">
                        <div class="text-center text-white">
                            <div class="text-6xl mb-4">üîç</div>
                            <p class="text-lg">Klik tombol untuk mulai absensi</p>
                        </div>
                    </div>
                    
                    <!-- Scanning Overlay -->
                    <div id="scanningOverlay" class="hidden absolute inset-0 pointer-events-none corner-brackets">
                        <div class="scanning-line"></div>
                    </div>
                    
                    <!-- Detection Notification - Below Camera Inside Container -->
                    <div id="detectionNotification" class="detection-notification absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 to-transparent">
                        <div id="notificationContent" class="bg-white rounded-2xl p-4 shadow-2xl flex items-center gap-4 success-glow">
                            <div class="relative">
                                <img id="notifPhoto" class="w-16 h-16 rounded-full object-cover border-4 border-green-500" alt="Foto">
                                <div class="absolute -bottom-1 -right-1 bg-green-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">‚úì</div>
                            </div>
                            <div class="flex-1">
                                <p class="font-bold text-gray-800 text-lg" id="notifName">-</p>
                                <p class="text-gray-500 text-sm" id="notifId">-</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span id="notifBadge" class="px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs font-bold">MASUK</span>
                                    <span class="text-gray-400 text-xs" id="notifTime">-</span>
                                </div>
                            </div>
                            <div id="notifIcon" class="text-5xl">‚úÖ</div>
                        </div>
                        <!-- Confidence Bar -->
                        <div class="mt-2 bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div id="confidenceBar" class="confidence-bar bg-gradient-to-r from-green-400 to-green-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="confidenceText" class="text-white text-xs mt-1 text-center">Akurasi: 0%</p>
                    </div>
                </div>
                
                <div class="flex gap-4 mt-6">
                    <button id="startAttendanceBtn" onclick="startAttendance()" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-4 px-6 rounded-2xl font-bold transition-all flex items-center justify-center gap-3 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        <span class="text-xl">‚ñ∂Ô∏è</span> Mulai Absensi
                    </button>
                    <button id="stopAttendanceBtn" onclick="stopAttendance()" class="flex-1 bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 text-white py-4 px-6 rounded-2xl font-bold transition-all flex items-center justify-center gap-3 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 hidden">
                        <span class="text-xl">‚èπÔ∏è</span> Berhenti
                    </button>
                </div>

                <!-- Mode Selection -->
                <div class="mt-6 grid grid-cols-2 gap-4">
                    <button onclick="setAttendanceMode('masuk')" id="modeIn" class="py-4 px-6 rounded-2xl font-bold transition-all duration-300 bg-gradient-to-r from-green-100 to-green-200 text-green-700 border-3 border-green-500 shadow-md">
                        üü¢ Mode Masuk
                    </button>
                    <button onclick="setAttendanceMode('pulang')" id="modeOut" class="py-4 px-6 rounded-2xl font-bold transition-all duration-300 bg-gray-100 text-gray-600 border-3 border-transparent hover:border-orange-300">
                        üî¥ Mode Pulang
                    </button>
                </div>
            </div>

            <div class="glass-card rounded-3xl shadow-xl p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                        <span class="text-3xl">üìä</span> Absensi Hari Ini
                    </h2>
                    <button onclick="clearTodayAttendance()" class="bg-red-100 hover:bg-red-200 text-red-600 px-4 py-2 rounded-xl text-sm font-bold transition-all">
                        üóëÔ∏è Hapus
                    </button>
                </div>
                
                <!-- Date & Time -->
                <div class="bg-gradient-to-r from-purple-600 to-indigo-700 rounded-2xl p-6 text-white mb-6 shadow-lg">
                    <div class="text-center">
                        <p class="text-sm opacity-80 font-medium">Tanggal & Waktu</p>
                        <p id="currentDateTime" class="text-xl font-bold mt-2"></p>
                    </div>
                </div>
                
                <!-- Stats -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl p-5 text-center border-2 border-green-200">
                        <p class="text-4xl font-extrabold text-green-600" id="totalMasuk">0</p>
                        <p class="text-sm text-green-800 font-medium mt-1">Absen Masuk</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-2xl p-5 text-center border-2 border-orange-200">
                        <p class="text-4xl font-extrabold text-orange-600" id="totalPulang">0</p>
                        <p class="text-sm text-orange-800 font-medium mt-1">Absen Pulang</p>
                    </div>
                </div>
                
                <!-- Records -->
                <div id="attendanceList" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                    <div class="text-center text-gray-400 py-10">
                        <p class="text-6xl mb-3">üì≠</p>
                        <p class="font-medium">Belum ada absensi hari ini</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Employees Tab -->
        <div id="employeesSection" class="hidden">
            <div class="glass-card rounded-3xl shadow-xl p-8">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                        <span class="text-3xl">üë•</span> Daftar Karyawan Terdaftar
                        <span id="employeeCount" class="bg-purple-100 text-purple-700 text-sm px-3 py-1 rounded-full font-bold">0</span>
                    </h2>
                    <button onclick="clearAllEmployees()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-bold transition-all shadow-md hover:shadow-lg">
                        üóëÔ∏è Hapus Semua
                    </button>
                </div>
                
                <div id="employeesList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="text-center text-gray-400 py-16 col-span-full">
                        <p class="text-6xl mb-3">üë§</p>
                        <p class="font-medium">Belum ada karyawan terdaftar</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 transform translate-x-full opacity-0 transition-all duration-500 z-50">
        <div class="glass-card rounded-2xl shadow-2xl p-5 flex items-center gap-4 border-l-4 border-green-500 min-w-80">
            <span id="toastIcon" class="text-3xl">‚úÖ</span>
            <div>
                <p id="toastTitle" class="font-bold text-gray-800 text-lg">Berhasil!</p>
                <p id="toastMessage" class="text-sm text-gray-600">-</p>
            </div>
        </div>
    </div>

    <!-- Image Zoom Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300" onclick="closeImageModal()">
        <div class="relative max-w-3xl max-h-[90vh] p-4">
            <button onclick="closeImageModal()" class="absolute -top-2 -right-2 bg-white text-gray-800 w-10 h-10 rounded-full flex items-center justify-center text-2xl font-bold shadow-lg hover:bg-gray-100 transition-all z-10">
                √ó
            </button>
            <img id="zoomedImage" src="" alt="Zoomed" class="max-w-full max-h-[80vh] rounded-2xl shadow-2xl object-contain transform scale-95 transition-transform duration-300">
            <div id="zoomImageInfo" class="mt-4 bg-white/10 backdrop-blur-md rounded-xl p-4 text-white text-center">
                <p id="zoomName" class="font-bold text-xl">-</p>
                <p id="zoomDetails" class="text-sm opacity-80 mt-1">-</p>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let registerStream = null;
        let attendanceStream = null;
        let isDetecting = false;
        let attendanceMode = 'masuk';
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
        let labeledDescriptors = [];
        let lastDetectedId = null;
        let detectionCooldown = false;
        let notificationTimeout = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadModels();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            updateEmployeesList();
            updateAttendanceList();
            updateStatistics();
            await loadLabeledDescriptors();
        });

        // Load Face-API Models
        async function loadModels() {
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model';
            
            try {
                const models = [
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ];

                let loaded = 0;
                for (const model of models) {
                    await model;
                    loaded++;
                    const progress = Math.round((loaded / models.length) * 100);
                    document.getElementById('loadingProgress').style.width = progress + '%';
                    document.getElementById('loadingText').textContent = progress + '%';
                }

                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loadingOverlay').classList.add('hidden');
                    }, 500);
                }, 500);
                
                showToast('success', 'Model AI Dimuat', 'Sistem siap digunakan');
            } catch (error) {
                console.error('Error loading models:', error);
                document.getElementById('loadingText').textContent = 'Gagal memuat model!';
                showToast('error', 'Error', 'Gagal memuat model AI');
            }
        }

        // Load Labeled Face Descriptors
        async function loadLabeledDescriptors() {
            labeledDescriptors = [];
            for (const emp of employees) {
                if (emp.descriptor) {
                    const descriptor = new Float32Array(Object.values(emp.descriptor));
                    labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(emp.id, [descriptor]));
                }
            }
        }

        // Tab Switching
        function switchTab(tab) {
            const tabs = ['register', 'attendance', 'employees'];
            tabs.forEach(t => {
                document.getElementById(t + 'Section').classList.add('hidden');
                document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.remove('tab-active');
                document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('text-gray-600');
            });
            
            document.getElementById(tab + 'Section').classList.remove('hidden');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('tab-active');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('text-gray-600');

            // Stop cameras when switching tabs
            if (tab !== 'register' && registerStream) {
                registerStream.getTracks().forEach(track => track.stop());
                registerStream = null;
                document.getElementById('registerStatus').classList.remove('hidden');
                document.getElementById('regFaceIndicator').classList.add('hidden');
            }
            if (tab !== 'attendance') {
                stopAttendance();
            }
        }

        // Register Camera
        async function startRegisterCamera() {
            try {
                if (registerStream) {
                    registerStream.getTracks().forEach(track => track.stop());
                }
                
                registerStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: 640, height: 480 },
                    audio: false
                });
                
                const video = document.getElementById('registerVideo');
                video.srcObject = registerStream;
                document.getElementById('registerStatus').classList.add('hidden');
                
                // Start face detection preview
                video.addEventListener('play', () => {
                    detectFacePreview();
                });
                
                showToast('success', 'Kamera Aktif', 'Posisikan wajah Anda di depan kamera');
            } catch (err) {
                console.error('Error:', err);
                showToast('error', 'Gagal', 'Tidak dapat mengakses kamera');
            }
        }

        // Face Detection Preview for Registration
        async function detectFacePreview() {
            const video = document.getElementById('registerVideo');
            const canvas = document.getElementById('registerCanvas');
            const ctx = canvas.getContext('2d');
            const indicator = document.getElementById('regFaceIndicator');

            if (!registerStream || video.paused || video.ended) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks();

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (detections.length > 0) {
                indicator.classList.remove('hidden');
                const dims = faceapi.matchDimensions(canvas, video, true);
                const resized = faceapi.resizeResults(detections, dims);
                faceapi.draw.drawDetections(canvas, resized);
                faceapi.draw.drawFaceLandmarks(canvas, resized);
            } else {
                indicator.classList.add('hidden');
            }

            requestAnimationFrame(detectFacePreview);
        }

        // Register Face
        async function registerFace() {
            const id = document.getElementById('regEmployeeId').value.trim();
            const name = document.getElementById('regEmployeeName').value.trim();
            const dept = document.getElementById('regDepartment').value;

            if (!id || !name) {
                showToast('error', 'Data Tidak Lengkap', 'ID dan Nama wajib diisi');
                return;
            }

            if (employees.find(e => e.id === id)) {
                showToast('error', 'ID Sudah Ada', 'Gunakan ID karyawan yang berbeda');
                return;
            }

            const video = document.getElementById('registerVideo');
            
            if (!registerStream) {
                showToast('error', 'Kamera Tidak Aktif', 'Aktifkan kamera terlebih dahulu');
                return;
            }

            try {
                const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptor();

                if (!detection) {
                    showToast('error', 'Wajah Tidak Terdeteksi', 'Pastikan wajah terlihat jelas di kamera');
                    return;
                }

                // Capture photo
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = video.videoWidth;
                tempCanvas.height = video.videoHeight;
                tempCanvas.getContext('2d').drawImage(video, 0, 0);
                const photo = tempCanvas.toDataURL('image/jpeg', 0.8);

                // Save employee
                const employee = {
                    id,
                    name,
                    department: dept,
                    photo,
                    descriptor: Array.from(detection.descriptor),
                    registeredAt: new Date().toISOString()
                };

                employees.push(employee);
                localStorage.setItem('employees', JSON.stringify(employees));
                
                // Update labeled descriptors
                labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(id, [detection.descriptor]));

                // Reset form
                document.getElementById('regEmployeeId').value = '';
                document.getElementById('regEmployeeName').value = '';
                document.getElementById('regDepartment').value = '';

                updateEmployeesList();
                showToast('success', 'Berhasil Terdaftar', `${name} (${id}) berhasil didaftarkan`);
            } catch (err) {
                console.error('Error:', err);
                showToast('error', 'Gagal', 'Terjadi kesalahan saat mendaftarkan wajah');
            }
        }

        // Start Attendance Detection
        async function startAttendance() {
            if (employees.length === 0) {
                showToast('error', 'Tidak Ada Karyawan', 'Daftarkan karyawan terlebih dahulu');
                return;
            }

            try {
                attendanceStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: 640, height: 480 },
                    audio: false
                });
                
                const video = document.getElementById('attendanceVideo');
                video.srcObject = attendanceStream;
                document.getElementById('attendanceStatus').classList.add('hidden');
                document.getElementById('scanningOverlay').classList.remove('hidden');
                document.getElementById('startAttendanceBtn').classList.add('hidden');
                document.getElementById('stopAttendanceBtn').classList.remove('hidden');
                document.getElementById('liveIndicator').classList.remove('hidden');
                document.getElementById('cameraContainer').classList.add('face-detected');
                
                isDetecting = true;
                video.addEventListener('play', () => {
                    detectAndRecognize();
                });
                
                showToast('success', 'Deteksi Aktif', 'Arahkan wajah ke kamera untuk absen');
            } catch (err) {
                console.error('Error:', err);
                showToast('error', 'Gagal', 'Tidak dapat mengakses kamera');
            }
        }

        // Stop Attendance Detection
        function stopAttendance() {
            isDetecting = false;
            if (attendanceStream) {
                attendanceStream.getTracks().forEach(track => track.stop());
                attendanceStream = null;
            }
            document.getElementById('attendanceStatus').classList.remove('hidden');
            document.getElementById('scanningOverlay').classList.add('hidden');
            document.getElementById('startAttendanceBtn').classList.remove('hidden');
            document.getElementById('stopAttendanceBtn').classList.add('hidden');
            document.getElementById('liveIndicator').classList.add('hidden');
            hideNotification();
            
            const canvas = document.getElementById('attendanceCanvas');
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        }

        // Detect and Recognize Faces
        async function detectAndRecognize() {
            const video = document.getElementById('attendanceVideo');
            const canvas = document.getElementById('attendanceCanvas');
            const ctx = canvas.getContext('2d');

            if (!isDetecting || !attendanceStream || video.paused || video.ended) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceDescriptors();

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (detections.length > 0 && labeledDescriptors.length > 0) {
                const dims = faceapi.matchDimensions(canvas, video, true);
                const resized = faceapi.resizeResults(detections, dims);

                const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.5);

                resized.forEach((detection, i) => {
                    const box = detection.detection.box;
                    const match = faceMatcher.findBestMatch(detections[i].descriptor);
                    
                    const isRecognized = match.label !== 'unknown';
                    const color = isRecognized ? '#22c55e' : '#ef4444';
                    const confidence = isRecognized ? Math.round((1 - match.distance) * 100) : 0;
                    
                    // Draw rounded box
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.roundRect(box.x, box.y, box.width, box.height, 15);
                    ctx.stroke();
                    
                    // Draw glow effect
                    ctx.shadowColor = color;
                    ctx.shadowBlur = 20;
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                    
                    // Draw label background
                    const employee = employees.find(e => e.id === match.label);
                    const displayName = employee ? employee.name : 'Tidak Dikenal';
                    
                    ctx.fillStyle = color;
                    const labelHeight = 35;
                    ctx.beginPath();
                    ctx.roundRect(box.x, box.y - labelHeight - 5, box.width, labelHeight, [10, 10, 0, 0]);
                    ctx.fill();
                    
                    // Draw label text
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 14px Inter';
                    ctx.textAlign = 'center';
                    ctx.fillText(displayName, box.x + box.width / 2, box.y - 15);
                    ctx.textAlign = 'left';

                    // Auto record attendance
                    if (isRecognized && !detectionCooldown) {
                        recordAutoAttendance(match.label, confidence);
                    }
                });
            }

            requestAnimationFrame(detectAndRecognize);
        }

        // Show Detection Notification
        function showNotification(employee, time, type, confidence, isExisting = false) {
            const notification = document.getElementById('detectionNotification');
            const content = document.getElementById('notificationContent');
            
            // Clear existing timeout
            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
            }
            
            // Update content
            document.getElementById('notifPhoto').src = employee.photo;
            document.getElementById('notifName').textContent = employee.name;
            document.getElementById('notifId').textContent = `${employee.id} ‚Ä¢ ${employee.department || 'Tanpa Dept'}`;
            document.getElementById('notifTime').textContent = time;
            
            const badge = document.getElementById('notifBadge');
            const icon = document.getElementById('notifIcon');
            
            if (isExisting) {
                badge.textContent = `SUDAH ${type.toUpperCase()}`;
                badge.className = 'px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold';
                icon.textContent = '‚ö†Ô∏è';
            } else {
                badge.textContent = type.toUpperCase();
                badge.className = type === 'masuk' 
                    ? 'px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs font-bold'
                    : 'px-2 py-0.5 bg-orange-100 text-orange-700 rounded-full text-xs font-bold';
                icon.textContent = '‚úÖ';
            }
            
            // Update confidence bar
            document.getElementById('confidenceBar').style.width = confidence + '%';
            document.getElementById('confidenceText').textContent = `Akurasi: ${confidence}%`;
            
            // Show notification with animation
            notification.classList.remove('hide');
            notification.classList.add('show');
            content.classList.add('success-glow');
            
            // Remove glow after animation
            setTimeout(() => {
                content.classList.remove('success-glow');
            }, 500);
            
            // Hide after 3 seconds
            notificationTimeout = setTimeout(() => {
                hideNotification();
            }, 3000);
        }

        // Hide Detection Notification
        function hideNotification() {
            const notification = document.getElementById('detectionNotification');
            notification.classList.remove('show');
            notification.classList.add('hide');
        }

        // Capture current frame from attendance camera
        function captureAttendancePhoto() {
            const video = document.getElementById('attendanceVideo');
            if (!video || !attendanceStream) return null;
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            tempCanvas.getContext('2d').drawImage(video, 0, 0);
            return tempCanvas.toDataURL('image/jpeg', 0.8);
        }

        // Open Image Modal for Zoom
        function openImageModal(imageSrc, name, details) {
            const modal = document.getElementById('imageModal');
            const zoomedImage = document.getElementById('zoomedImage');
            
            zoomedImage.src = imageSrc;
            document.getElementById('zoomName').textContent = name;
            document.getElementById('zoomDetails').textContent = details;
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                zoomedImage.classList.remove('scale-95');
                zoomedImage.classList.add('scale-100');
            }, 10);
        }

        // Close Image Modal
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            const zoomedImage = document.getElementById('zoomedImage');
            
            modal.classList.add('opacity-0');
            zoomedImage.classList.remove('scale-100');
            zoomedImage.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // Record Auto Attendance
        function recordAutoAttendance(employeeId, confidence) {
            if (detectionCooldown) return;

            const employee = employees.find(e => e.id === employeeId);
            if (!employee) return;

            const now = new Date();
            const today = now.toLocaleDateString('id-ID');
            const time = now.toLocaleTimeString('id-ID');
            
            // Check if already recorded today for this type
            const existingRecord = attendanceRecords.find(r => 
                r.employeeId === employeeId && 
                r.date === today && 
                r.type === attendanceMode
            );

            if (existingRecord) {
                // Show existing record notification
                showNotification(employee, existingRecord.time, attendanceMode, confidence, true, existingRecord.photo);
                detectionCooldown = true;
                setTimeout(() => { detectionCooldown = false; }, 3000);
                return;
            }

            // Capture photo from current camera frame
            const capturedPhoto = captureAttendancePhoto() || employee.photo;

            // Create new record with captured photo
            const record = {
                id: Date.now(),
                employeeId: employee.id,
                employeeName: employee.name,
                department: employee.department,
                photo: capturedPhoto, // Photo from camera at attendance time
                profilePhoto: employee.photo, // Original registration photo
                type: attendanceMode,
                timestamp: now.toISOString(),
                date: today,
                time: time,
                confidence: confidence
            };

            attendanceRecords.unshift(record);
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            
            // Show success notification
            showNotification(employee, time, attendanceMode, confidence, false);
            updateAttendanceList();
            updateStatistics();

            // Play success sound
            playSuccessSound();

            // Show toast as well
            showToast('success', `Absen ${attendanceMode === 'masuk' ? 'Masuk' : 'Pulang'} Berhasil`, `${employee.name} - ${time}`);

            detectionCooldown = true;
            setTimeout(() => { detectionCooldown = false; }, 5000);
        }

        // Set Attendance Mode
        function setAttendanceMode(mode) {
            attendanceMode = mode;
            if (mode === 'masuk') {
                document.getElementById('modeIn').className = 'py-4 px-6 rounded-2xl font-bold transition-all duration-300 bg-gradient-to-r from-green-100 to-green-200 text-green-700 border-3 border-green-500 shadow-md';
                document.getElementById('modeOut').className = 'py-4 px-6 rounded-2xl font-bold transition-all duration-300 bg-gray-100 text-gray-600 border-3 border-transparent hover:border-orange-300';
            } else {
                document.getElementById('modeOut').className = 'py-4 px-6 rounded-2xl font-bold transition-all duration-300 bg-gradient-to-r from-orange-100 to-orange-200 text-orange-700 border-3 border-orange-500 shadow-md';
                document.getElementById('modeIn').className = 'py-4 px-6 rounded-2xl font-bold transition-all duration-300 bg-gray-100 text-gray-600 border-3 border-transparent hover:border-green-300';
            }
        }

        // Play Success Sound
        function playSuccessSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Create a pleasant two-tone beep
            const playTone = (freq, startTime, duration) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = freq;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + startTime + duration);
                
                oscillator.start(audioContext.currentTime + startTime);
                oscillator.stop(audioContext.currentTime + startTime + duration);
            };
            
            playTone(880, 0, 0.15);
            playTone(1320, 0.15, 0.2);
        }

        // Update Employees List
        function updateEmployeesList() {
            const list = document.getElementById('employeesList');
            document.getElementById('employeeCount').textContent = employees.length;
            
            if (employees.length === 0) {
                list.innerHTML = `
                    <div class="text-center text-gray-400 py-16 col-span-full">
                        <p class="text-6xl mb-3">üë§</p>
                        <p class="font-medium">Belum ada karyawan terdaftar</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = employees.map(emp => `
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl p-6 flex items-center gap-5 hover:shadow-lg transition-all duration-300 border border-gray-200 hover:border-purple-300">
                    <img src="${emp.photo}" alt="${emp.name}" class="w-20 h-20 rounded-full object-cover border-4 border-purple-500 shadow-md">
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-gray-800 text-lg truncate">${emp.name}</p>
                        <p class="text-sm text-gray-500 font-medium">${emp.id}</p>
                        <span class="inline-block mt-2 px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-bold">${emp.department || 'Tanpa Departemen'}</span>
                    </div>
                    <button onclick="deleteEmployee('${emp.id}')" class="text-red-400 hover:text-red-600 p-3 hover:bg-red-50 rounded-full transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `).join('');
        }

        // Delete Employee
        async function deleteEmployee(id) {
            if (!confirm('Hapus karyawan ini?')) return;
            
            employees = employees.filter(e => e.id !== id);
            localStorage.setItem('employees', JSON.stringify(employees));
            await loadLabeledDescriptors();
            updateEmployeesList();
            showToast('success', 'Berhasil', 'Karyawan berhasil dihapus');
        }

        // Clear All Employees
        async function clearAllEmployees() {
            if (!confirm('Hapus semua karyawan? Data tidak dapat dikembalikan.')) return;
            
            employees = [];
            localStorage.removeItem('employees');
            labeledDescriptors = [];
            updateEmployeesList();
            showToast('success', 'Berhasil', 'Semua karyawan berhasil dihapus');
        }

        // Update Attendance List
        function updateAttendanceList() {
            const list = document.getElementById('attendanceList');
            const today = new Date().toLocaleDateString('id-ID');
            const todayRecords = attendanceRecords.filter(r => r.date === today);
            
            if (todayRecords.length === 0) {
                list.innerHTML = `
                    <div class="text-center text-gray-400 py-10">
                        <p class="text-6xl mb-3">üì≠</p>
                        <p class="font-medium">Belum ada absensi hari ini</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = todayRecords.map(record => `
                <div class="flex items-center gap-4 p-4 bg-gradient-to-r ${record.type === 'masuk' ? 'from-green-50 to-emerald-50 border-green-200' : 'from-orange-50 to-amber-50 border-orange-200'} rounded-2xl border hover:shadow-md transition-all">
                    <div class="relative group cursor-pointer" onclick="openImageModal('${record.photo}', '${record.employeeName}', '${record.employeeId} ‚Ä¢ ${record.department || 'Tanpa Dept'} ‚Ä¢ ${record.time}')">
                        <img src="${record.photo}" alt="Foto" class="w-14 h-14 rounded-full object-cover border-3 ${record.type === 'masuk' ? 'border-green-500' : 'border-orange-500'} transition-transform group-hover:scale-110">
                        <div class="absolute inset-0 bg-black/40 rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <span class="text-white text-lg">üîç</span>
                        </div>
                        <div class="absolute -bottom-1 -right-1 bg-blue-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                            <span>+</span>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-gray-800 truncate">${record.employeeName}</p>
                        <div class="flex items-center gap-2 mt-1 flex-wrap">
                            <span class="text-xs text-gray-500 font-medium bg-gray-100 px-2 py-0.5 rounded">üÜî ${record.employeeId}</span>
                            <span class="text-xs text-purple-600 font-medium bg-purple-50 px-2 py-0.5 rounded">üè¢ ${record.department || 'Tanpa Dept'}</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">‚è∞ ${record.time}</p>
                    </div>
                    <div class="text-right">
                        <span class="px-3 py-1.5 rounded-full text-xs font-bold ${record.type === 'masuk' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                            ${record.type === 'masuk' ? 'üü¢ Masuk' : 'üî¥ Pulang'}
                        </span>
                        <p class="text-xs text-gray-400 mt-1">${record.confidence || 0}% akurat</p>
                    </div>
                </div>
            `).join('');
        }

        // Update Statistics
        function updateStatistics() {
            const today = new Date().toLocaleDateString('id-ID');
            const todayRecords = attendanceRecords.filter(r => r.date === today);
            
            document.getElementById('totalMasuk').textContent = todayRecords.filter(r => r.type === 'masuk').length;
            document.getElementById('totalPulang').textContent = todayRecords.filter(r => r.type === 'pulang').length;
        }

        // Clear Today Attendance
        function clearTodayAttendance() {
            if (!confirm('Hapus semua absensi hari ini?')) return;
            
            const today = new Date().toLocaleDateString('id-ID');
            attendanceRecords = attendanceRecords.filter(r => r.date !== today);
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            updateAttendanceList();
            updateStatistics();
            showToast('success', 'Berhasil', 'Absensi hari ini berhasil dihapus');
        }

        // Update Date Time
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('id-ID', options);
        }

        // Show Toast
        function showToast(type, title, message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastIcon').textContent = type === 'success' ? '‚úÖ' : '‚ùå';
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastMessage').textContent = message;
            
            toast.querySelector('div').className = `glass-card rounded-2xl shadow-2xl p-5 flex items-center gap-4 border-l-4 min-w-80 ${type === 'success' ? 'border-green-500' : 'border-red-500'}`;
            
            toast.classList.remove('translate-x-full', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
            }, 3000);
        }
    </script>
</body>
</html>
<style></style><script></script>
